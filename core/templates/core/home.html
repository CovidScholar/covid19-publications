{% extends "core/base.html" %}
{% load static %}
{% block content %}

    <div class="gradient-header">
        <div class="container py-3 text-white">
            <div class="row h-100 align-items-center py-5">
                <div class="col-lg-8">
                    <h1 class="display-4">Explore COVID-19 Preprints</h1>
                    <p class="muted-white lead mb-0">
                        Since 13th January 2019, {{ papers|length }} articles concerning the COVID-19 virus are
                        published on preprint
                        servers and collected by <strong>Collabovid</strong>. Most of
                        these papers are not reviewed in a professional reviewing process at the time of publication on
                        the preprint server. You can search for any topic you want below.
                        Visit <a class="muted-white" href="{% url "explore" %}">explore</a> to review all articles or
                        browse a list of
                        predefined <a class="muted-white" href="{% url "topic-overview" %}">topics</a>. For additional
                        help visit the
                        <a class="muted-white" href="{% url "about" %}">frequently asked questions</a>.

                    </p>
                </div>
                <div class="col-lg-4">
                    <img src="{% static "core/img/research-2.png" %}" class="img-fluid rounded">
                </div>
            </div>

        </div>

        <div class="container">
            <br/>
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8">
                    <form action="{% url "home" %}" method="POST"
                          id="topic-search-form">
                        {% csrf_token %}

                        <div class="search-bar-rounded-corners card card-sm">
                            <div class="search-form-card-body row no-gutters align-items-center">

                                <div class="col-lg-10 col-md-10 col-sm-11 col">

                                    <div class="row align-items-center">

                                        <div class="col-0 col-sm-0 col-md-1 col-lg-1 col-xl-1">
                                            <span class="d-none d-sm-none d-md-inline d-lg-inline d-xl-inline">
                                                <i class="fas fa-search fa-2x text-body"></i>
                                            </span>
                                        </div>
                                        <!--end of col-->
                                        <div class="col">
                                            <input name="query"
                                                   class="form-control search-form-control form-control-borderless"
                                                   type="search"
                                                   placeholder="E.g.: What do we know about vaccines and therapeutics?">
                                        </div>
                                    </div>

                                </div>
                                <!--end of col-->
                                <div class="col-lg-2 col-md-2 col-sm-1 col-auto text-center">
                                    <button class="btn btn-lg btn-info
                                    d-none d-sm-none d-md-block d-lg-block d-xl-block" type="submit">
                                        <span class="">Search</span>
                                    </button>
                                    <button class="btn btn-lg btn-info
                                    d-block d-sm-block d-md-none d-lg-none d-xl-none rounded-circle" type="submit">
                                        <i class="fas fa-search text-body"></i>
                                    </button>

                                </div>
                                <!--end of col-->
                            </div>
                        </div>
                    </form>
                </div>
                <!--end of col-->
            </div>
        </div>
        {% include 'core/partials/_rounded_bottom.html' %}
    </div>

    <div class="container">
        <div id="sorted-by-container" class="row align-items-center mt-5 mb-0 pb-0" style="display: none;">

            <div class="offset-lg-6 col-lg-2 col-2 text-right align-middle">
                <label class="m-0" for="sorted-by">Sort by:</label>
            </div>

            <div class="col-lg-4">
                {% include 'core/partials/_sort_select.html' with best_matching=True %}
            </div>

        </div>

        <div id="paper-container">
        </div>

        <div id="paper-loading-indicator" class="text-muted text-center fa-5x my-5" style="display: none;">
            <i class="fas fa-circle-notch fa-spin"></i>
        </div>

        <nav id="pagination-container"></nav>
    </div>



{% endblock %}

{% block script %}
    {% include 'core/partials/_paper_card.html' with script=True html=False %}
    <script src="{% static "core/js/pagination.js" %}" type="text/javascript"></script>


    <script type="text/javascript">
        $(document).ready(function () {

            window.Pagination = {};

            let indicator = $("#paper-loading-indicator");
            let paper_container = $("#paper-container");
            let pagination_container = $("#pagination-container");
            let form = $("#topic-search-form");
            let sorted_by_select = $("#sorted-by");
            let sorted_by_container = $("#sorted-by-container");

            update_pagination_container = pagination_container.paginate({
                searchQuery: search_query,
            });

            function search_query(data, page, on_success) {

                paper_container.hide();
                indicator.show();

                data += "&page=" + page;
                data += "&" + sorted_by_select.attr('name') + "=" + sorted_by_select.val();

                $.ajax({
                    url: form.attr("action"),
                    type: 'POST',
                    data: data,
                    success: function (data) {
                        paper_container.html(data);

                        if (Pagination.result_size > 0) {
                            sorted_by_container.show();
                        } else {
                            sorted_by_container.hide();
                        }

                        indicator.hide();
                        paper_container.fadeIn();

                        update_pagination_container();

                        if (on_success) {
                            on_success();
                        }
                    },
                    error: function (request, error) {
                        console.log("Request: " + JSON.stringify(request));
                        console.log("Error: " + error);
                    }
                });
            }

            form.submit(function (e) {
                e.preventDefault();
                sorted_by_container.hide();

                search_query(form.serialize(), 1, function () {
                    window.Pagination.last_request = form.serialize();
                });
            });

            sorted_by_select.change(function (e) {
                search_query(window.Pagination.last_request, 1);
            });

        });
    </script>
{% endblock %}

{% block css %}
{% endblock %}